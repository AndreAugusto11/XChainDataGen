from extractor.mayan.utils.OrderHash import (
    reconstruct_order_hash,
    reconstruct_order_hash_from_params,
)

# AS EXAMPLE WE USE THIS TX SIGNATURE:
# 5dYcKoFLzUT6ffkVt5buWCxJGtDLfRu8xvRpoZDUanJ64VUPicSWsyc8Gr3hBsfUiBRgniaEPwbTwEUuL8gPSXuX


def test_reconstruct_order_hash():
    order_params = {
        "auction_mode": 2,
        "deadline": 1737985953,
        "dstAddress": "0xa13a8b7c03e1975f52a4b20a6dfb3c6448da4015",
        "dstChainId": 30,
        "gasDrop": 0,
        "mayan_bps": 3,
        "minAmountOut": 4808512,
        "random": "fae8f16aff9e07efebc5fa39038226400e7d16a36081ee373b63883421507ac2",
        "referrer_addr": "0xadcc69b2c313c2d6bc637af80754bc51c9766e51",
        "referrer_bps": 0,
        "refund_fee_dst": 739,
        "refund_fee_src": 300000,
        "src_chain_id": 1,
        "token_in": "7vfCXTUXx5WJV5JADk17DUJ4ksgau7utNKj4b963voxs",
        "token_out": "0x0000000000000000000000000000000000000000",
        "trader": "Br9WyhaWG4sxkQVExnq9cQMTKKijWmFNNPED4SuLASBb",
    }

    order_hash = reconstruct_order_hash(
        trader=order_params["trader"],
        src_chain_id=order_params["src_chain_id"],
        token_in=order_params["token_in"],
        dest_chain_id=order_params["dstChainId"],
        token_out=order_params["token_out"],
        min_amount_out64=order_params["minAmountOut"],
        gas_drop64=order_params["gasDrop"],
        refund_fee_dest64=order_params["refund_fee_dst"],
        refund_fee_src64=order_params["refund_fee_src"],
        deadline=order_params["deadline"],
        dest_addr=order_params["dstAddress"],
        referrer_addr=order_params["referrer_addr"],
        referrer_bps=order_params["referrer_bps"],
        mayan_bps=order_params["mayan_bps"],
        auction_mode=order_params["auction_mode"],
        random=order_params["random"],
    )

    assert order_hash == "69c102b971fa4758450865d6741c961c0e73d8246a7fb11709e4970bced9777b"


def test_reconstruct_order_hash_from_params():
    params = {
        "amountInMin": "4d6629",
        "nativeInput": False,
        "feeSubmit": "0",
        "addrDest": [
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            161,
            58,
            139,
            124,
            3,
            225,
            151,
            95,
            82,
            164,
            178,
            10,
            109,
            251,
            60,
            100,
            72,
            218,
            64,
            21,
        ],
        "chainDest": 30,
        "tokenOut": [
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
        ],
        "amountOutMin": "495f40",
        "gasDrop": "0",
        "feeCancel": "2e3",
        "feeRefund": "493e0",
        "deadline": "67978fa1",
        "addrRef": [
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            0,
            173,
            204,
            105,
            178,
            195,
            19,
            194,
            214,
            188,
            99,
            122,
            248,
            7,
            84,
            188,
            81,
            201,
            118,
            110,
            81,
        ],
        "feeRateRef": 0,
        "feeRateMayan": 3,
        "auctionMode": 2,
        "keyRnd": [
            250,
            232,
            241,
            106,
            255,
            158,
            7,
            239,
            235,
            197,
            250,
            57,
            3,
            130,
            38,
            64,
            14,
            125,
            22,
            163,
            96,
            129,
            238,
            55,
            59,
            99,
            136,
            52,
            33,
            80,
            122,
            194,
        ],
    }

    order_hash = reconstruct_order_hash_from_params(
        trader="Br9WyhaWG4sxkQVExnq9cQMTKKijWmFNNPED4SuLASBb",
        token_in="7vfCXTUXx5WJV5JADk17DUJ4ksgau7utNKj4b963voxs",
        src_chain_id=1,
        params=params,
    )

    assert order_hash == "69c102b971fa4758450865d6741c961c0e73d8246a7fb11709e4970bced9777b"
